<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AstroGuide</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <script>
      // Check if user data exists
      const userData = localStorage.getItem("userData");
      if (!userData) {
        window.location.href = "landing.html";
      }
    </script>

    <div class="chat-container">
      <div class="chat-header">
        <h1>AstroGuide</h1>
        <button id="logout-button" class="logout-button">Logout</button>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="message bot-message">
          Hello! I'm AstroGuide. What would you like to know?
        </div>
      </div>
      <div class="input-container">
        <input
          type="text"
          id="message-input"
          placeholder="Type your message here..."
        />
        <button id="send-button">Send</button>
      </div>
    </div>

    <script>
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const chatMessages = document.getElementById("chat-messages");
      const logoutButton = document.getElementById("logout-button");

      function addMessage(message, isUser = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${
          isUser ? "user-message" : "bot-message"
        }`;
        messageDiv.textContent = message;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function handleSendMessage() {
        const message = messageInput.value.trim();
        if (message) {
          addMessage(message, true);
          messageInput.value = "";

          // Get user data from localStorage
          const userData = JSON.parse(localStorage.getItem("userData"));

          if (!userData) {
            addMessage(
              "Error: No user data found. Please log in or create an account first."
            );
            return;
          }

          console.log("Sending birth data:", userData);

          // Parse birth date and time
          const birthDate = new Date(userData.birthDate);
          const [hours, minutes] = userData.birthTime.split(":").map(Number);

          // Make API call to backend
          fetch("http://localhost:3000/api/birth-chart", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              year: birthDate.getFullYear(),
              month: birthDate.getMonth() + 1, // JavaScript months are 0-based
              day: birthDate.getDate(),
              hour: hours,
              minute: minutes,
              latitude: 40.7128, // Default to New York coordinates
              longitude: -74.006,
              timezone: "America/New_York",
            }),
          })
            .then((response) => {
              if (!response.ok) {
                return response.json().then((err) => {
                  throw new Error(
                    err.details ||
                      err.error ||
                      "Failed to calculate birth chart"
                  );
                });
              }
              return response.json();
            })
            .then((data) => {
              console.log("Received birth chart data:", data);

              // Function to convert degrees to zodiac sign
              function getZodiacSign(degrees) {
                const signs = [
                  { name: "Aries", element: "Fire", start: 0, end: 30 },
                  { name: "Taurus", element: "Earth", start: 30, end: 60 },
                  { name: "Gemini", element: "Air", start: 60, end: 90 },
                  { name: "Cancer", element: "Water", start: 90, end: 120 },
                  { name: "Leo", element: "Fire", start: 120, end: 150 },
                  { name: "Virgo", element: "Earth", start: 150, end: 180 },
                  { name: "Libra", element: "Air", start: 180, end: 210 },
                  { name: "Scorpio", element: "Water", start: 210, end: 240 },
                  {
                    name: "Sagittarius",
                    element: "Fire",
                    start: 240,
                    end: 270,
                  },
                  { name: "Capricorn", element: "Earth", start: 270, end: 300 },
                  { name: "Aquarius", element: "Air", start: 300, end: 330 },
                  { name: "Pisces", element: "Water", start: 330, end: 360 },
                ];

                // Handle undefined or null degrees
                if (degrees === undefined || degrees === null) {
                  console.error("Invalid degrees value:", degrees);
                  return {
                    sign: "Unknown",
                    element: "Unknown",
                    degree: "0.00",
                  };
                }

                // Normalize degrees to 0-360 range
                const normalizedDegrees = ((degrees % 360) + 360) % 360;

                // Find the sign that contains these degrees
                const sign = signs.find(
                  (s) =>
                    normalizedDegrees >= s.start && normalizedDegrees < s.end
                );

                // If no sign is found (shouldn't happen with normalized degrees), return the last sign
                if (!sign) {
                  console.error(
                    "No sign found for degrees:",
                    normalizedDegrees
                  );
                  return { sign: "Pisces", element: "Water", degree: "0.00" };
                }

                const degreeInSign = normalizedDegrees - sign.start;
                return {
                  sign: sign.name,
                  element: sign.element,
                  degree: degreeInSign.toFixed(2),
                };
              }

              // Function to get house number
              function getHouseNumber(degrees, ascendant) {
                if (degrees === undefined || ascendant === undefined) {
                  console.error("Invalid degrees or ascendant:", {
                    degrees,
                    ascendant,
                  });
                  return 1;
                }
                const houseSize = 30; // Each house is 30 degrees
                const normalizedDegrees = (degrees - ascendant + 360) % 360;
                return Math.floor(normalizedDegrees / houseSize) + 1;
              }

              // Format planetary positions with zodiac signs
              const formatPlanetPosition = (planet, degrees) => {
                if (degrees === undefined) {
                  console.error("Invalid degrees for planet:", planet);
                  return `${planet}: Unknown position`;
                }
                const position = getZodiacSign(degrees);
                return `${planet}: ${position.degree}째 ${position.sign} (${position.element})`;
              };

              // Get ascendant sign
              const ascendantSign = getZodiacSign(data.ascendant);

              // Format the birth chart information
              const birthChartInfo = `
Birth Chart Details:
Ascendant: ${ascendantSign.degree}째 ${ascendantSign.sign} (${
                ascendantSign.element
              })
Midheaven: ${getZodiacSign(data.mc).degree}째 ${getZodiacSign(data.mc).sign}

Planetary Positions:
${Object.entries(data.planets)
  .map(([planet, position]) => {
    const planetNames = {
      sun: "Sun",
      moon: "Moon",
      mars: "Mars",
      mercury: "Mercury",
      jupiter: "Jupiter",
      venus: "Venus",
      saturn: "Saturn",
      uranus: "Uranus",
      neptune: "Neptune",
      pluto: "Pluto",
    };
    return formatPlanetPosition(planetNames[planet], position);
  })
  .join("\n")}

Houses:
${data.houses.houses
  .map((house, index) => {
    const houseSign = getZodiacSign(house);
    return `House ${index + 1}: ${houseSign.degree}째 ${houseSign.sign}`;
  })
  .join("\n")}
`;
              addMessage(birthChartInfo);
            })
            .catch((error) => {
              console.error("Error:", error);
              addMessage(`Error: ${error.message}`);
            });
        }
      }

      // Add a function to test the backend connection
      function testBackendConnection() {
        fetch("http://localhost:3000/api/test")
          .then((response) => response.json())
          .then((data) => {
            console.log("Backend test response:", data);
          })
          .catch((error) => {
            console.error("Backend connection test failed:", error);
          });
      }

      // Test backend connection when page loads
      testBackendConnection();

      // Logout handler
      logoutButton.addEventListener("click", () => {
        // Clear all stored data
        localStorage.clear();
        // Redirect to landing page
        window.location.href = "landing.html";
      });

      sendButton.addEventListener("click", handleSendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          handleSendMessage();
        }
      });
    </script>
  </body>
</html>
