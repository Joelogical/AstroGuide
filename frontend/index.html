<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AstroGuide</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <script>
      // Check if user data exists
      const userData = localStorage.getItem("userData");
      if (!userData) {
        window.location.href = "landing.html";
      }
    </script>

    <div class="chat-container">
      <div class="chat-header">
        <h1>AstroGuide</h1>
        <button id="logout-button" class="logout-button">Logout</button>
      </div>
      <div class="chat-messages" id="chat-messages">
        <div class="message bot-message">
          Hello! I'm AstroGuide. What would you like to know?
        </div>
      </div>
      <div class="input-container">
        <input
          type="text"
          id="message-input"
          placeholder="Type your message here..."
        />
        <button id="send-button">Send</button>
      </div>
    </div>

    <script>
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const chatMessages = document.getElementById("chat-messages");
      const logoutButton = document.getElementById("logout-button");

      function addMessage(message, isUser = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${
          isUser ? "user-message" : "bot-message"
        }`;
        messageDiv.textContent = message;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function handleSendMessage() {
        const message = messageInput.value.trim();
        if (message) {
          addMessage(message, true);
          messageInput.value = "";

          // Get user data from localStorage
          const userData = JSON.parse(localStorage.getItem("userData"));

          if (!userData) {
            addMessage(
              "Error: No user data found. Please log in or create an account first."
            );
            return;
          }

          // If message is "test", fetch birth chart
          if (message.toLowerCase() === "test") {
            addMessage("Fetching your birth chart...");

            // Parse birth date and time directly from strings
            const [year, month, day] = userData.birthDate
              .split("-")
              .map(Number);
            const [hours, minutes] = userData.birthTime.split(":").map(Number);

            console.log("Parsed date components:", {
              year,
              month,
              day,
              hours,
              minutes,
            });

            // Function to get coordinates from city name
            async function getCoordinates(cityName) {
              try {
                const response = await fetch(
                  `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
                    cityName
                  )}`
                );
                const data = await response.json();

                if (data && data.length > 0) {
                  return {
                    latitude: parseFloat(data[0].lat),
                    longitude: parseFloat(data[0].lon),
                  };
                }
                throw new Error("Location not found");
              } catch (error) {
                console.error("Error getting coordinates:", error);
                // Default to New York coordinates
                return {
                  latitude: 40.7128,
                  longitude: -74.006,
                };
              }
            }

            // Get coordinates from birth place
            const birthPlace = userData.birthPlace || "New York, USA";
            const coordinates = await getCoordinates(birthPlace);
            console.log("Resolved coordinates:", coordinates);

            const requestData = {
              year: year,
              month: month,
              day: day,
              hour: hours,
              minute: minutes,
              latitude: coordinates.latitude,
              longitude: coordinates.longitude,
              timezone: -5, // Default to EST, we can make this dynamic based on coordinates later
            };

            console.log("Sending birth data to server:", requestData);

            // Make API call to backend
            fetch("http://localhost:3000/api/birth-chart", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(requestData),
            })
              .then((response) => {
                if (!response.ok) {
                  return response.json().then((err) => {
                    throw new Error(
                      err.details ||
                        err.error ||
                        "Failed to calculate birth chart"
                    );
                  });
                }
                return response.json();
              })
              .then((data) => {
                console.log("Received birth chart data:", data);

                // Format the birth chart information
                const birthChartInfo = formatBirthChartInfo(data);
                addMessage(birthChartInfo);
              })
              .catch((error) => {
                console.error("Error details:", error);
                let errorMessage =
                  "An error occurred while calculating your birth chart.";

                if (error.message) {
                  errorMessage = error.message;
                } else if (error.details) {
                  errorMessage = error.details;
                }

                addMessage(`Error: ${errorMessage}`);
              });
            return;
          }

          // Handle other messages here
          addMessage(
            "I'm not sure how to help with that yet. Try typing 'test' to see your birth chart!"
          );
        }
      }

      // Add a function to test the backend connection
      function testBackendConnection() {
        fetch("http://localhost:3000/api/test")
          .then((response) => response.json())
          .then((data) => {
            console.log("Backend test response:", data);
          })
          .catch((error) => {
            console.error("Backend connection test failed:", error);
          });
      }

      // Test backend connection when page loads
      testBackendConnection();

      // Logout handler
      logoutButton.addEventListener("click", () => {
        // Clear all stored data
        localStorage.clear();
        // Redirect to landing page
        window.location.href = "landing.html";
      });

      sendButton.addEventListener("click", handleSendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          handleSendMessage();
        }
      });

      function formatBirthChartInfo(birthChart) {
        let info = "";

        // Only show the interpretation if available
        if (birthChart.interpretation) {
          info += birthChart.interpretation;
        } else if (birthChart.interpretationError) {
          info += `Error getting interpretation: ${birthChart.interpretationError}`;
        }

        // Add a button to view raw chart data
        info += '<div class="chart-data-container">';
        info +=
          '<button onclick="toggleRawChartData(this)" class="view-data-btn" data-chart=\'' +
          JSON.stringify(birthChart) +
          "'>View Raw Chart Data</button>";
        info += "</div>";
        return info;
      }

      // Add function to toggle raw chart data visibility
      function toggleRawChartData(button) {
        const container = button.parentElement;
        let rawDataDiv = container.querySelector(".raw-chart-data");

        if (!rawDataDiv) {
          // Create raw data div if it doesn't exist
          rawDataDiv = document.createElement("div");
          rawDataDiv.className = "raw-chart-data";
          rawDataDiv.style.display = "none";

          const birthChart = JSON.parse(button.dataset.chart);
          let rawData = "";

          // Birth Data
          rawData += "Birth Data:\n";
          rawData += `Date: ${birthChart.birthData.date}\n`;
          rawData += `Time: ${birthChart.birthData.time}\n`;
          rawData += `Location: ${birthChart.birthData.location.latitude}°N, ${birthChart.birthData.location.longitude}°E (UTC${birthChart.birthData.location.timezone})\n\n`;

          // Angular Points
          rawData += "Angular Points:\n";
          rawData += `Ascendant: ${birthChart.angles.ascendant.degree.toFixed(
            2
          )}° ${birthChart.angles.ascendant.sign} (${
            birthChart.angles.ascendant.element
          })\n`;
          rawData += `Midheaven: ${birthChart.angles.midheaven.degree.toFixed(
            2
          )}° ${birthChart.angles.midheaven.sign} (${
            birthChart.angles.midheaven.element
          })\n\n`;

          // Planetary Positions
          rawData += "Planetary Positions:\n";
          for (const [planet, data] of Object.entries(birthChart.planets)) {
            rawData += `${
              planet.charAt(0).toUpperCase() + planet.slice(1)
            }: ${data.degree.toFixed(2)}° ${data.sign} (${data.element})`;
            if (data.isRetrograde) rawData += " ℞";
            rawData += ` - House ${data.house}\n`;
          }
          rawData += "\n";

          // Houses
          rawData += "Houses:\n";
          birthChart.houses.forEach((house) => {
            rawData += `House ${house.number}: ${house.degree.toFixed(2)}° ${
              house.sign
            } (${house.element})\n`;
          });
          rawData += "\n";

          // Aspects
          rawData += "Aspects:\n";
          birthChart.aspects.forEach((aspect) => {
            rawData += `${
              aspect.planet1.charAt(0).toUpperCase() + aspect.planet1.slice(1)
            } ${aspect.aspect} ${
              aspect.planet2.charAt(0).toUpperCase() + aspect.planet2.slice(1)
            } (${aspect.orb.toFixed(2)}° orb)\n`;
          });

          rawDataDiv.textContent = rawData;
          container.appendChild(rawDataDiv);
        }

        if (rawDataDiv.style.display === "none") {
          rawDataDiv.style.display = "block";
          button.textContent = "Hide Raw Chart Data";
        } else {
          rawDataDiv.style.display = "none";
          button.textContent = "View Raw Chart Data";
        }
      }

      // Add CSS for the button and container
      const style = document.createElement("style");
      style.textContent = `
        .chart-data-container {
          margin-top: 15px;
        }
        .view-data-btn {
          background-color: #4CAF50;
          border: none;
          color: white;
          padding: 10px 20px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
          margin: 4px 2px;
          cursor: pointer;
          border-radius: 4px;
        }
        .view-data-btn:hover {
          background-color: #45a049;
        }
        .raw-chart-data {
          background-color: #f8f9fa;
          padding: 15px;
          border-radius: 4px;
          margin-top: 10px;
          white-space: pre-wrap;
          font-family: monospace;
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
